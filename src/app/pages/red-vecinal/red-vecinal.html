<!-- Toast -->
<div class="toast-top" *ngIf="toastVisible">
  {{ toastMsg }}
</div>

<div class="rv-page">
  <div class="rv-header">
    <div class="rv-title">
      <h1>Red Vecinal</h1>
      <p>Comunidad por colonia: alertas, posts y apoyo entre vecinos.</p>
    </div>

    <!-- ‚úÖ Solo botones arriba -->
    <div class="rv-actions">
      <button class="btn ghost" (click)="abrirUnirme()">Unirme</button>
      <button class="btn primary" (click)="abrirCrearColonia()">Crear colonia</button>
    </div>
  </div>

  <div class="rv-content" *ngIf="!loading; else loadingTpl">
    <div class="card">
      <div class="card-head">
        <div>
          <h3>Mi colonia</h3>
          <p class="muted" *ngIf="misColonias.length===0">
            A√∫n no est√°s en ninguna colonia. Usa los botones de arriba para unirte o crear una.
          </p>
        </div>

        <div class="right" *ngIf="misColonias.length>0">
          <select class="select" [ngModel]="coloniaActivaId" (ngModelChange)="setColoniaActiva($event)">
            <option *ngFor="let c of misColonias" [ngValue]="c.id">
              {{ c.nombre }}
            </option>
          </select>
        </div>
      </div>

      <div class="card-body" *ngIf="coloniaActiva; else noColoniaTpl">
        <div class="colonia-info">
          <div>
            <div class="label">Colonia</div>
            <div class="value">{{ coloniaActiva.nombre }}</div>
          </div>

          <div>
            <div class="label">C√≥digo</div>
            <div class="value mono">{{ coloniaActiva.codigoInvitacion }}</div>
          </div>

          <div>
            <div class="label">Due√±o</div>
            <div class="value">{{ coloniaActiva.userId === userId ? 'T√∫' : ('Usuario #' + coloniaActiva.userId) }}</div>
          </div>

          <div class="right">
            <button class="btn primary" (click)="abrirNuevoPost()">Publicar</button>
          </div>
        </div>
      </div>

      <!-- ‚úÖ Ya NO hay botones aqu√≠ abajo -->
      <ng-template #noColoniaTpl>
        <div class="empty">
          <div class="emoji">üèòÔ∏è</div>
          <div class="txt">
            <div class="t">√önete o crea una colonia</div>
            <div class="s">Usa los botones de arriba. Con un c√≥digo puedes entrar a la colonia de un vecino.</div>
          </div>
        </div>
      </ng-template>
    </div>

    <div class="feed" *ngIf="coloniaActiva">
      <div class="feed-head">
        <h3>Publicaciones</h3>
        <span class="pill" *ngIf="posts.length">{{ posts.length }} posts</span>
      </div>

      <div class="post card" *ngFor="let p of posts">
        <div class="post-top">
          <div class="who">
            <div class="name">{{ p.autorNombre }}</div>
            <div class="meta">
              <span class="date">{{ p.fechaCreacion }}</span>
              <span class="tag alert" *ngIf="p.esAlerta">ALERTA</span>
            </div>
          </div>

          <button class="btn icon" (click)="toggleLike(p.id)" [class.active]="p.yoLike" title="Like">
            ‚ù§Ô∏è <span class="cnt">{{ p.likesCount }}</span>
          </button>
        </div>

        <div class="post-body">
          {{ p.contenido }}
        </div>

        <div class="post-bottom">
          <button class="btn ghost sm" (click)="toggleComentarios(p.id)">
            üí¨ Comentarios ({{ p.commentsCount }})
          </button>
        </div>

        <div class="comments" *ngIf="mostrarComentarios[p.id]">
          <div class="comment" *ngFor="let c of getComentariosDe(p.id)">
            <div class="c-head">
              <div class="c-name">{{ nombreDeUser(c.userId) }}</div>
              <div class="c-date">{{ c.fechaCreacion }}</div>
            </div>
            <div class="c-body">{{ c.contenido }}</div>
          </div>

          <div class="comment-box">
            <input
              class="input"
              placeholder="Escribe un comentario..."
              [(ngModel)]="nuevoComentario[p.id]"
              (keyup.enter)="comentar(p.id)"
            />
            <button class="btn primary sm" (click)="comentar(p.id)">Enviar</button>
          </div>
        </div>
      </div>

      <div class="empty small" *ngIf="posts.length===0">
        <div class="emoji">üìù</div>
        <div class="txt">
          <div class="t">Todav√≠a no hay posts</div>
          <div class="s">S√© el primero en publicar algo en tu colonia.</div>
        </div>
        <button class="btn primary" (click)="abrirNuevoPost()">Publicar</button>
      </div>
    </div>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">
      Cargando Red Vecinal...
    </div>
  </ng-template>
</div>

<!-- =======================
     MODAL: CREAR COLONIA
     ‚úÖ Renombrado para no chocar con Bootstrap (.modal)
======================= -->
<div class="rv-overlay" *ngIf="modalCrearColonia" (click)="closeModals()">
  <div class="rv-modal" (click)="$event.stopPropagation()">
    <div class="rv-modal-head">
      <h3>Crear colonia</h3>
      <button class="rv-x" (click)="closeModals()">‚úï</button>
    </div>

    <div class="rv-modal-body">
      <label>Nombre</label>
      <input class="input" [(ngModel)]="crearNombre" placeholder="Ej. Blue Slide Park" />

      <label>C√≥digo de invitaci√≥n</label>
      <div class="row">
        <input class="input mono" [(ngModel)]="crearCodigo" maxlength="10" />
        <button class="btn ghost sm" (click)="crearCodigo = generarCodigoInvitacion()">üîÑ</button>
      </div>
      <div class="hint">Tip: comparte este c√≥digo con tus vecinos.</div>
    </div>

    <div class="rv-modal-foot">
      <button class="btn ghost" (click)="closeModals()">Cancelar</button>
      <button class="btn primary" (click)="crearColonia()">Crear</button>
    </div>
  </div>
</div>

<!-- =======================
     MODAL: UNIRME
======================= -->
<div class="rv-overlay" *ngIf="modalUnirme" (click)="closeModals()">
  <div class="rv-modal" (click)="$event.stopPropagation()">
    <div class="rv-modal-head">
      <h3>Unirme a una colonia</h3>
      <button class="rv-x" (click)="closeModals()">‚úï</button>
    </div>

    <div class="rv-modal-body">
      <label>C√≥digo de invitaci√≥n</label>
      <input class="input mono" [(ngModel)]="unirmeCodigo" placeholder="Ej. HDQXWYU9" />
    </div>

    <div class="rv-modal-foot">
      <button class="btn ghost" (click)="closeModals()">Cancelar</button>
      <button class="btn primary" (click)="unirmeColonia()">Unirme</button>
    </div>
  </div>
</div>

<!-- =======================
     MODAL: NUEVO POST
======================= -->
<div class="rv-overlay" *ngIf="modalNuevoPost" (click)="closeModals()">
  <div class="rv-modal" (click)="$event.stopPropagation()">
    <div class="rv-modal-head">
      <h3>Nueva publicaci√≥n</h3>
      <button class="rv-x" (click)="closeModals()">‚úï</button>
    </div>

    <div class="rv-modal-body">
      <label>Contenido</label>
      <textarea class="textarea" [(ngModel)]="postContenido" rows="5" placeholder="¬øQu√© est√° pasando en tu colonia?"></textarea>

      <div class="check">
        <input type="checkbox" [(ngModel)]="postEsAlerta" id="alerta" />
        <label for="alerta">Marcar como alerta</label>
      </div>
    </div>

    <div class="rv-modal-foot">
      <button class="btn ghost" (click)="closeModals()">Cancelar</button>
      <button class="btn primary" (click)="publicarPost()">Publicar</button>
    </div>
  </div>
</div>

<div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
  <div>
    <div class="h3 m-0 pc-title">Red Vecinal</div>
    <div class="pc-muted">Comunidad por colonia: alertas, fotos y apoyo entre vecinos.</div>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <button class="btn btn-outline-light pc-btn" (click)="reload()"><i class="bi bi-arrow-clockwise"></i></button>
    <button class="btn btn-outline-light pc-btn" (click)="openJoin()"><i class="bi bi-door-open me-1"></i>Unirme</button>
    <button class="btn btn-primary pc-btn" (click)="openCreateColonia()"><i class="bi bi-plus-lg me-1"></i>Crear colonia</button>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-12 col-xl-4">
    <div class="pc-card pc-shadow p-3">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="h5 m-0 pc-title">Mi colonia</div>
          <div class="pc-muted small">Selecciona una colonia</div>
        </div>
        <select class="form-select pc-input" style="width: 210px" [value]="(selectedColoniaId() ?? '').toString()" (change)="selectedColoniaId.set($any($event.target).value ? +$any($event.target).value : null)">
          <option value="">—</option>
          @for (c of myColonias(); track c.id) {
            <option [value]="c.id">{{ c.nombre }}</option>
          }
        </select>
      </div>
      <div class="pc-divider my-3"></div>

      @if (!selectedColonia()) {
        <div class="pc-muted">Crea o únete a una colonia para ver el feed.</div>
      } @else {
        <div class="pc-surface p-3">
          <div class="fw-semibold">{{ selectedColonia()?.nombre }}</div>
          <div class="small pc-muted">Código: <span class="fw-semibold">{{ selectedColonia()?.codigoInvitacion }}</span></div>
          <div class="small pc-muted">Compártelo para invitar vecinos.</div>
        </div>

        <div class="pc-divider my-3"></div>

        <div class="fw-semibold">Publicar</div>
        <form class="d-grid gap-2 mt-2" [formGroup]="postForm" (ngSubmit)="publishPost()">
          <textarea class="form-control pc-input" rows="4" formControlName="contenido" placeholder="Escribe algo útil para tus vecinos..."></textarea>
          <div class="d-flex justify-content-between align-items-center">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="alerta" formControlName="esAlerta" />
              <label class="form-check-label" for="alerta">Es alerta</label>
            </div>
            <button class="btn btn-primary pc-btn" type="submit"><i class="bi bi-send me-1"></i>Publicar</button>
          </div>
          <div>
            <label class="form-label small pc-muted">Imágenes (URLs, una por línea)</label>
            <textarea class="form-control pc-input" rows="2" formControlName="imageUrls" placeholder="https://...
https://..."></textarea>
          </div>
        </form>
      }
    </div>
  </div>

  <div class="col-12 col-xl-8">
    @if (!selectedColonia()) {
      <div class="pc-card pc-shadow p-4">
        <div class="h5 pc-title">Aún no hay colonia seleccionada</div>
        <div class="pc-muted">Únete con un código o crea tu propia colonia.</div>
      </div>
    } @else {
      <div class="d-grid gap-3">
        @if (feed().length === 0) {
          <div class="pc-card pc-shadow p-4">
            <div class="h5 pc-title">Sin publicaciones</div>
            <div class="pc-muted">Sé el primero en publicar algo en tu colonia.</div>
          </div>
        }

        @for (p of feed(); track p.id) {
          <div class="pc-card pc-shadow p-3" [class.alerta]="p.esAlerta">
            <div class="d-flex align-items-start justify-content-between gap-2">
              <div>
                <div class="fw-semibold">{{ userName(p.usuarioId) }}</div>
                <div class="small pc-muted">{{ format(p.fechaCreacion) }}</div>
              </div>
              @if (p.esAlerta) { <span class="pc-badge"><i class="bi bi-exclamation-triangle me-1"></i>Alerta</span> }
            </div>

            <div class="mt-2" style="white-space: pre-wrap;">{{ p.contenido }}</div>

            @if (imagesForPost(p.id).length > 0) {
              <div class="pc-post-grid mt-3">
                @for (im of imagesForPost(p.id); track im.id) {
                  <img [src]="im.imagePath" alt="" />
                }
              </div>
            }

            <div class="d-flex flex-wrap gap-2 mt-3">
              <button class="btn btn-outline-light pc-btn" (click)="toggleLike(p)">
                <i class="bi" [class.bi-heart-fill]="isLikedByMe(p.id)" [class.bi-heart]="!isLikedByMe(p.id)"></i>
                <span class="ms-1">{{ likesCount(p.id) }}</span>
              </button>
              <button class="btn btn-outline-light pc-btn" (click)="toggleComments(p.id)">
                <i class="bi bi-chat"></i>
                <span class="ms-1">{{ commentsFor(p.id).length }}</span>
              </button>
            </div>

            @if (expandedComments()[p.id || -1]) {
              <div class="pc-divider my-3"></div>
              <div class="d-grid gap-2">
                @for (c of commentsFor(p.id); track c.id) {
                  <div class="pc-surface p-2">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="small fw-semibold">{{ userName(c.userId) }}</div>
                      <div class="small pc-muted">{{ format(c.fechaCreacion) }}</div>
                    </div>
                    <div class="small" style="white-space: pre-wrap;">{{ c.contenido }}</div>
                  </div>
                }
              </div>

              <form class="mt-3" [formGroup]="commentForms()[p.id || -1]" (ngSubmit)="submitComment(p.id!)">
                <div class="d-flex gap-2">
                  <input class="form-control pc-input" formControlName="contenido" placeholder="Escribe un comentario…" />
                  <button class="btn btn-primary pc-btn" type="submit"><i class="bi bi-send"></i></button>
                </div>
              </form>
            }
          </div>
        }
      </div>
    }
  </div>
</div>

<app-modal [open]="showCreate()" title="Crear colonia" (closed)="showCreate.set(false)">
  <form class="d-grid gap-3" [formGroup]="createColoniaForm" (ngSubmit)="createColonia()">
    <div>
      <label class="form-label">Nombre</label>
      <input class="form-control pc-input" formControlName="nombre" placeholder="Mi colonia" />
    </div>
    <div>
      <label class="form-label">Código de invitación</label>
      <input class="form-control pc-input" formControlName="codigoInvitacion" />
      <div class="pc-muted small mt-1">Tip: comparte este código con tus vecinos.</div>
    </div>
    <div class="d-flex justify-content-end gap-2">
      <button type="button" class="btn btn-outline-light pc-btn" (click)="showCreate.set(false)">Cancelar</button>
      <button class="btn btn-primary pc-btn" type="submit">Crear</button>
    </div>
  </form>
</app-modal>

<app-modal [open]="showJoin()" title="Unirme a una colonia" (closed)="showJoin.set(false)">
  <form class="d-grid gap-3" [formGroup]="joinForm" (ngSubmit)="join()">
    <div>
      <label class="form-label">Código de invitación</label>
      <input class="form-control pc-input" formControlName="codigoInvitacion" placeholder="ABCDEFGH" />
    </div>
    <div class="d-flex justify-content-end gap-2">
      <button type="button" class="btn btn-outline-light pc-btn" (click)="showJoin.set(false)">Cancelar</button>
      <button class="btn btn-primary pc-btn" type="submit">Unirme</button>
    </div>
  </form>
</app-modal>

<div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
  <div>
    <div class="h3 m-0 pc-title">Perfil</div>
    <div class="pc-muted">Edita tus datos y tu foto de perfil.</div>
  </div>
  <button class="btn btn-outline-light pc-btn" (click)="loadStats()" title="Actualizar resumen">
    <i class="bi bi-arrow-clockwise"></i>
  </button>
</div>

<div class="row g-3 mt-1">
  <div class="col-12 col-xl-4">
    <div class="pc-card pc-shadow p-3">
      <div class="d-flex align-items-center gap-3">
        <div class="pc-profile-avatar">
          @if (me().fotoPerfil) {
            <img [src]="me().fotoPerfil" alt="Foto de perfil" />
          } @else {
            <span>{{ initials() }}</span>
          }
        </div>
        <div style="min-width: 0">
          <div class="h5 m-0 pc-title text-truncate">{{ me().nombre }}</div>
          <div class="pc-muted text-truncate">{{ me().email }}</div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <span class="pc-badge"><i class="bi bi-person-badge me-1"></i>ID #{{ me().id }}</span>
            <span class="pc-badge"><i class="bi bi-shield-lock me-1"></i>Cuenta</span>
          </div>
        </div>
      </div>

      <div class="pc-divider my-3"></div>

      <div class="fw-semibold">Foto de perfil</div>
      <div class="pc-muted small">Pega una URL de imagen (Drive, Imgur, etc.).</div>

      <div class="mt-3">
        <div class="pc-photo-preview">
          @if (photoUrl.value) {
            <img [src]="photoUrl.value" alt="Vista previa" />
          } @else {
            <div class="pc-muted"><i class="bi bi-image"></i></div>
          }
        </div>

        <label class="form-label mt-3">URL</label>
        <input class="form-control pc-input" [formControl]="photoUrl" placeholder="https://..." />

        <button
          class="btn btn-primary pc-btn w-100 mt-2"
          (click)="savePhoto()"
          [disabled]="busy() || !photoUrl.value.trim()"
        >
          @if (busy()) {
            <span class="spinner-border spinner-border-sm me-2"></span>
          }
          Guardar foto
        </button>
      </div>
    </div>

    <div class="pc-card pc-shadow p-3 mt-3">
      <div class="h5 pc-title m-0">Resumen</div>
      <div class="pc-muted small">Tu actividad en la plataforma</div>
      <div class="pc-divider my-3"></div>

      @if (statsLoading()) {
        <div class="pc-muted">
          <span class="spinner-border spinner-border-sm me-2"></span>
          Cargando…
        </div>
      } @else {
        <div class="row g-2">
          <div class="col-6">
            <div class="pc-surface p-3">
              <div class="pc-muted small">Mascotas</div>
              <div class="h4 m-0">{{ stats().mascotas ?? '—' }}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="pc-surface p-3">
              <div class="pc-muted small">Posts</div>
              <div class="h4 m-0">{{ stats().posts ?? '—' }}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="pc-surface p-3">
              <div class="pc-muted small">Adopciones</div>
              <div class="h4 m-0">{{ stats().adopciones ?? '—' }}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="pc-surface p-3">
              <div class="pc-muted small">Solicitudes</div>
              <div class="h4 m-0">{{ stats().solicitudes ?? '—' }}</div>
            </div>
          </div>
        </div>

        <div class="pc-divider my-3"></div>

        <div class="pc-muted small">Mes actual</div>
        <div class="d-flex justify-content-between mt-1">
          <span class="pc-muted">Gasto</span>
          <span class="fw-semibold">${{ stats().gastoMes ?? 0 }}</span>
        </div>
        <div class="d-flex justify-content-between mt-1">
          <span class="pc-muted">Presupuesto</span>
          <span class="fw-semibold">@if (stats().budgetMes != null) { ${{ stats().budgetMes }} } @else { — }</span>
        </div>

        @if (stats().budgetMes != null) {
          <div class="progress mt-2 pc-budget" style="height: 7px; background: rgba(255,255,255,0.08)">
            <div class="progress-bar" role="progressbar" [style.width]="budgetPct() + '%'"></div>
          </div>
          <div class="small pc-muted mt-2">{{ budgetHint() }}</div>
        }
      }
    </div>
  </div>

  <div class="col-12 col-xl-8">
    <div class="pc-card pc-shadow p-3">
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div>
          <div class="h5 m-0 pc-title">Datos del perfil</div>
          <div class="pc-muted small">Estos datos se muestran en la plataforma.</div>
        </div>
        <span class="pc-badge"><i class="bi bi-info-circle me-1"></i>Sin edición de contraseña</span>
      </div>

      <div class="pc-divider my-3"></div>

      <form class="row g-2" [formGroup]="form" (ngSubmit)="save()">
        <div class="col-12 col-md-6">
          <label class="form-label">Nombre</label>
          <input class="form-control pc-input" formControlName="nombre" placeholder="Tu nombre" />
          @if (form.controls.nombre.touched && form.controls.nombre.invalid) {
            <div class="text-warning small mt-1">El nombre es obligatorio.</div>
          }
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Correo</label>
          <input class="form-control pc-input" formControlName="email" type="email" placeholder="tu@correo.com" />
          @if (form.controls.email.touched && form.controls.email.invalid) {
            <div class="text-warning small mt-1">Ingresa un correo válido.</div>
          }
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Teléfono (opcional)</label>
          <input class="form-control pc-input" formControlName="telefonoCelular" placeholder="55..." />
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">CURP (opcional)</label>
          <input class="form-control pc-input" formControlName="curp" placeholder="XXXX000000XXXXXX00" />
        </div>

        <div class="col-12 d-flex justify-content-end gap-2 mt-2">
          <button class="btn btn-primary pc-btn" type="submit" [disabled]="busy()">
            @if (busy()) { <span class="spinner-border spinner-border-sm me-2"></span> }
            Guardar cambios
          </button>
        </div>
      </form>
    </div>

    <div class="pc-card pc-shadow p-3 mt-3">
      <div class="h5 pc-title m-0">Privacidad</div>
      <div class="pc-muted small mt-1">
        En esta versión la contraseña no se edita desde el front. La actualización conserva tu contraseña actual en el
        servidor.
      </div>
    </div>
  </div>
</div>
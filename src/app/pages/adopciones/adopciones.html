<!-- Toast -->
<div class="toast-top" *ngIf="toastVisible">
  {{ toastMsg }}
</div>

<div class="adopciones-page">
  <div class="topbar">
    <div>
      <h1>Adopciones</h1>
      <p class="sub">Publica, explora y da seguimiento a solicitudes.</p>

      <div class="tabs">
        <button class="tab" [class.active]="vista==='explorar'" (click)="setVista('explorar')">
          Explorar
        </button>
        <button class="tab" [class.active]="vista==='misPublicaciones'" (click)="setVista('misPublicaciones')">
          Mis publicaciones
        </button>
        <button class="tab" [class.active]="vista==='misSolicitudes'" (click)="setVista('misSolicitudes')">
          Mis solicitudes
        </button>
        <button class="tab" [class.active]="vista==='solicitudesRecibidas'" (click)="setVista('solicitudesRecibidas')">
          Solicitudes recibidas
        </button>
      </div>
    </div>

    <div class="actions">
      <button class="btn" (click)="refrescarTodo()">⟳</button>
      <button class="btn primary" (click)="abrirModalPublicar()">+ Publicar</button>
    </div>
  </div>

  <div class="layout">
    <!-- LISTA PRINCIPAL -->
    <div class="left">
      <div *ngIf="cargando" class="loading">Cargando...</div>

      <!-- Explorar -->
      <ng-container *ngIf="vista==='explorar'">
        <div *ngFor="let ad of adopciones" class="card">
          <div class="card-head">
            <div class="pet-row">
              <!-- Foto -->
              <ng-container *ngIf="getFotoMascota(ad) as foto; else nofoto">
                <img class="pet-img" [src]="foto" alt="Foto mascota">
              </ng-container>
              <ng-template #nofoto>
                <div class="pet-ph">{{ getNombreMascota(ad).charAt(0) }}</div>
              </ng-template>

              <!-- Info -->
              <div class="pet-info">
                <div class="title">{{ getNombreMascota(ad) }}</div>
                <div class="meta" *ngIf="getCaracteristicasMascota(ad)">
                  {{ getCaracteristicasMascota(ad) }}
                </div>
                <div class="meta">
                  Dueño: <b>{{ getNombreDueno(ad) }}</b>
                  <span *ngIf="ad.fechaPublicacion"> · {{ ad.fechaPublicacion }}</span>
                </div>

                <!-- Badge si ya solicitaste -->
                <div class="badges" *ngIf="yaSolicite(ad)">
                  <span class="badge requested">
                    Ya solicitaste · {{ formatEstado(getSolicitudDe(ad)!.estado) }}
                  </span>
                </div>
              </div>
            </div>

            <div class="pill" [class.ok]="ad.disponible" [class.no]="!ad.disponible">
              {{ ad.disponible ? 'Disponible' : 'No disponible' }}
            </div>
          </div>

          <div class="card-actions">
            <button class="btn primary"
                    [disabled]="!ad.disponible || yaSolicite(ad) || (userId!=null && ad.usuarioPublicadorId===userId)"
                    (click)="abrirModalSolicitud(ad)">
              {{ yaSolicite(ad) ? 'Solicitada' : 'Solicitar' }}
            </button>
          </div>
        </div>

        <div *ngIf="!cargando && adopciones.length===0" class="empty">
          No hay publicaciones por ahora.
        </div>
      </ng-container>

      <!-- Mis publicaciones -->
      <ng-container *ngIf="vista==='misPublicaciones'">
        <div *ngFor="let ad of misPublicaciones" class="card">
          <div class="card-head">
            <div class="pet-row">
              <ng-container *ngIf="getFotoMascota(ad) as foto; else nofoto2">
                <img class="pet-img" [src]="foto" alt="Foto mascota">
              </ng-container>
              <ng-template #nofoto2>
                <div class="pet-ph">{{ getNombreMascota(ad).charAt(0) }}</div>
              </ng-template>

              <div class="pet-info">
                <div class="title">{{ getNombreMascota(ad) }}</div>
                <div class="meta" *ngIf="getCaracteristicasMascota(ad)">
                  {{ getCaracteristicasMascota(ad) }}
                </div>
                <div class="meta">Mascota #{{ ad.mascotaId }}</div>
                <div class="meta" *ngIf="ad.fechaPublicacion">Publicado: {{ ad.fechaPublicacion }}</div>
              </div>
            </div>

            <div class="pill" [class.ok]="ad.disponible" [class.no]="!ad.disponible">
              {{ ad.disponible ? 'Disponible' : 'No disponible' }}
            </div>
          </div>

          <div class="card-actions">
            <button class="btn" (click)="toggleDisponibilidad(ad)">
              Cambiar disponibilidad
            </button>
            <button class="btn danger" (click)="eliminarPublicacion(ad)">
              Eliminar
            </button>
          </div>
        </div>

        <div *ngIf="!cargando && misPublicaciones.length===0" class="empty">
          No tienes publicaciones.
        </div>
      </ng-container>

      <!-- Mis solicitudes -->
      <ng-container *ngIf="vista==='misSolicitudes'">
        <div *ngFor="let s of misSolicitudes" class="card">
          <div class="card-head">
            <div>
              <div class="title">Solicitud #{{ s.id }}</div>
              <div class="meta">Adopción #{{ s.adopcionId }}</div>
              <div class="meta" *ngIf="s.fechaSolicitud">Fecha: {{ s.fechaSolicitud }}</div>
              <div class="meta" *ngIf="s.mensaje">Mensaje: {{ s.mensaje }}</div>
            </div>

            <div class="pill ok">
              {{ formatEstado(s.estado) }}
            </div>
          </div>

          <div class="card-actions">
            <button class="btn danger"
                    (click)="cancelarSolicitud(s)"
                    [disabled]="s.estado !== 'pendiente'">
              Cancelar
            </button>
          </div>
        </div>

        <div *ngIf="!cargando && misSolicitudes.length===0" class="empty">
          No has enviado solicitudes.
        </div>
      </ng-container>

      <!-- Solicitudes recibidas -->
      <ng-container *ngIf="vista==='solicitudesRecibidas'">
        <div *ngFor="let s of solicitudesRecibidas" class="card">
          <div class="card-head">
            <div class="pet-row">
              <ng-container *ngIf="getAdopcionDeSolicitud(s) as ad">
                <ng-container *ngIf="getFotoMascota(ad) as foto; else nofotoR">
                  <img class="pet-img" [src]="foto" alt="Foto mascota" (error)="onImgError($event)">
                </ng-container>
                <ng-template #nofotoR>
                  <div class="pet-ph">{{ (getMascotaDeSolicitud(s)?.nombre || ('M' + s.id)).charAt(0) }}</div>
                </ng-template>
              </ng-container>

              <div class="pet-info">
                <div class="title">
                  {{ getMascotaDeSolicitud(s)?.nombre || ('Mascota #' + (getAdopcionDeSolicitud(s)?.mascotaId || '')) }}
                </div>
                <div class="meta" *ngIf="getAdopcionDeSolicitud(s) as ad">
                  {{ getCaracteristicasMascota(ad) }}
                </div>
                <div class="meta">Solicitante: <b>{{ getNombreSolicitante(s) }}</b></div>
                <div class="meta" *ngIf="s.fechaSolicitud">Fecha: {{ s.fechaSolicitud }}</div>
                <div class="meta" *ngIf="s.mensaje">Mensaje: {{ s.mensaje }}</div>
              </div>
            </div>

            <div class="pill" [class.ok]="s.estado==='aceptada'" [class.no]="s.estado==='rechazada'">
              {{ formatEstado(s.estado) }}
            </div>
          </div>

          <div class="card-actions" *ngIf="s.estado==='pendiente'">
            <button class="btn primary" (click)="cambiarEstadoSolicitud(s,'aceptada')">Aceptar</button>
            <button class="btn danger" (click)="cambiarEstadoSolicitud(s,'rechazada')">Rechazar</button>
          </div>
        </div>

        <div *ngIf="!cargando && solicitudesRecibidas.length===0" class="empty">
          Aún no te han enviado solicitudes.
        </div>
      </ng-container>


    </div>

    <!-- INVENTARIO -->
    <div class="right">
      <div class="panel">
        <div class="panel-title">Tu inventario</div>
        <div class="panel-sub">Mascotas que puedes publicar</div>

        <div *ngIf="inventario.length===0" class="empty">
          No tienes mascotas registradas.
        </div>

        <div *ngFor="let m of inventario" class="inv-item">
          <div class="inv-left">
            <div class="inv-name">{{ m.nombre || ('Mascota #' + m.id) }}</div>
            <div class="inv-meta">
              <span *ngIf="m.tipo">{{ m.tipo }}</span>
              <span *ngIf="m.raza"> · {{ m.raza }}</span>
            </div>
          </div>

          <!-- Marcado si ya está en adopción -->
          <div class="inv-right" *ngIf="mascotaEnAdopcion(m.id) as ad">
            <span class="badge inventory">
              En adopción · {{ ad.disponible ? 'Disponible' : 'No disponible' }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL SOLICITUD (pc- para no chocar con bootstrap) -->
  <div class="pc-modal-backdrop" *ngIf="modalSolicitudOpen">
    <div class="pc-modal">
      <div class="pc-modal-head">
        <div class="pc-modal-title">Solicitar adopción</div>
        <button class="pc-modal-x" (click)="cerrarModalSolicitud()">✕</button>
      </div>

      <div class="pc-modal-body">
        <div class="meta">
          Vas a solicitar: <b>{{ getNombreMascota(selectedAdopcion!) }}</b>
        </div>

        <label class="label">Mensaje (opcional)</label>
        <textarea class="textarea"
                  [(ngModel)]="mensajeSolicitud"
                  placeholder="Cuéntale al dueño por qué serías un buen adoptante..."></textarea>
      </div>

      <div class="pc-modal-actions">
        <button class="btn" (click)="cerrarModalSolicitud()">Cancelar</button>
        <button class="btn primary" (click)="enviarSolicitud()">Enviar solicitud</button>
      </div>
    </div>
  </div>

  <!-- MODAL PUBLICAR -->
  <div class="pc-modal-backdrop" *ngIf="modalPublicarOpen">
    <div class="pc-modal">
      <div class="pc-modal-head">
        <div class="pc-modal-title">Publicar adopción</div>
        <button class="pc-modal-x" (click)="cerrarModalPublicar()">✕</button>
      </div>

      <div class="pc-modal-body">
        <label class="label">Selecciona una mascota</label>

        <select class="select" [(ngModel)]="selectedMascotaId">
          <option [ngValue]="null">-- Selecciona --</option>
          <option *ngFor="let m of inventario" [ngValue]="m.id">
            {{ m.nombre || ('Mascota #' + m.id) }}
          </option>
        </select>

        <div class="hint" *ngIf="selectedMascotaId && mascotaEnAdopcion(selectedMascotaId)">
          Esa mascota ya está publicada en adopción.
        </div>
      </div>

      <div class="pc-modal-actions">
        <button class="btn" (click)="cerrarModalPublicar()">Cancelar</button>
        <button class="btn primary" (click)="publicarDesdeInventario()">Publicar</button>
      </div>
    </div>
  </div>
</div>

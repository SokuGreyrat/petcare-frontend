<!-- Toast -->
<div class="toast-top" *ngIf="toastVisible" [class.err]="toastType==='err'">
  {{ toastMsg }}
</div>

<div class="finanzas-page">
  <div class="topbar">
    <div>
      <h1>Finanzas</h1>
      <p class="sub">Presupuesto mensual y gastos por mascota.</p>

      <div class="filters">
        <div class="filter">
          <label>Mascota</label>
          <select [(ngModel)]="mascotaSeleccionadaId" (change)="onContextChange()">
            <option [ngValue]="null" *ngIf="loadingMascotas">Cargando mascotas...</option>

            <option [ngValue]="null" *ngIf="!loadingMascotas && mascotas.length === 0">
              No tienes mascotas registradas
            </option>

            <option [ngValue]="null" *ngIf="!loadingMascotas && mascotas.length > 0">
              Selecciona una mascota
            </option>

            <option *ngFor="let m of mascotas" [ngValue]="m.idMascota">
              {{ m.nombre }}
            </option>
          </select>
        </div>

        <div class="filter">
          <label>Mes</label>
          <select [(ngModel)]="mesSeleccionado" (change)="onContextChange()">
            <option *ngFor="let m of meses" [ngValue]="m.num">{{ m.nombre }}</option>
          </select>
        </div>

        <div class="filter">
          <label>Año</label>
          <select [(ngModel)]="anioSeleccionado" (change)="onContextChange()">
            <option *ngFor="let a of anios" [ngValue]="a">{{ a }}</option>
          </select>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn secondary" (click)="abrirModalPresupuesto()">Presupuesto</button>
      <button class="btn primary" (click)="abrirModalGasto()">+ Registrar gasto</button>
    </div>
  </div>

  <div class="content">
    <div class="cards">
      <div class="card">
        <div class="title">Presupuesto</div>
        <div class="value">
          <span *ngIf="presupuestoMonto !== null; else dash1">
            {{ presupuestoMonto | currency:'MXN' }}
          </span>
          <ng-template #dash1>—</ng-template>
        </div>
      </div>

      <div class="card">
        <div class="title">Gasto del mes</div>
        <div class="value">{{ totalGastos | currency:'MXN' }}</div>
      </div>

      <div class="card">
        <div class="title">Restante</div>
        <div class="value">{{ restante | currency:'MXN' }}</div>
      </div>
    </div>

    <div class="gastos">
      <h3>Gastos del mes</h3>

      <div class="empty" *ngIf="gastos.length === 0">
        No hay gastos registrados en este mes.
      </div>

      <div class="list" *ngIf="gastos.length > 0">
        <div class="gasto-item" *ngFor="let g of gastos">
          <div class="left">
            <div class="cat">{{ g.categoria }}</div>
            <div class="desc" *ngIf="g.descripcion">{{ g.descripcion }}</div>
          </div>
          <div class="right">
            <div class="amt">{{ g.monto | currency:'MXN' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!-- MODAL PRESUPUESTO -->
  <!-- ========================= -->
  <div class="pc-modal-backdrop" *ngIf="modalPresupuesto" (click)="cerrarModales()"></div>

  <div class="pc-modal" *ngIf="modalPresupuesto">
    <div class="pc-modal-header">
      <h2>Configurar presupuesto</h2>
      <button class="pc-x" (click)="cerrarModales()">✕</button>
    </div>

    <div class="pc-modal-body">
      <div class="field">
        <label>Monto</label>
        <input type="number" [(ngModel)]="formPresupuesto.monto" placeholder="Ej. 1500" />
      </div>

      <div class="hint">
        Se guardará para <b>{{ nombreMes(mesSeleccionado) }} {{ anioSeleccionado }}</b>.
      </div>
    </div>

    <div class="pc-modal-actions">
      <button class="btn secondary" (click)="cerrarModales()">Cancelar</button>
      <button class="btn primary" [disabled]="loading" (click)="guardarPresupuesto()">Guardar</button>
    </div>
  </div>

  <!-- ========================= -->
  <!-- MODAL GASTO -->
  <!-- ========================= -->
  <div class="pc-modal-backdrop" *ngIf="modalGasto" (click)="cerrarModales()"></div>

  <div class="pc-modal" *ngIf="modalGasto">
    <div class="pc-modal-header">
      <h2>Registrar gasto</h2>
      <button class="pc-x" (click)="cerrarModales()">✕</button>
    </div>

    <div class="pc-modal-body">
      <div class="field">
        <label>Categoría</label>
        <select [(ngModel)]="formGasto.categoria">
          <option value="Alimento">Alimento</option>
          <option value="Veterinario">Veterinario</option>
          <option value="Higiene">Higiene</option>
          <option value="Juguetes">Juguetes</option>
          <option value="Otros">Otros</option>
        </select>
      </div>

      <div class="field">
        <label>Monto</label>
        <input type="number" [(ngModel)]="formGasto.monto" placeholder="Ej. 250" />
      </div>

      <div class="field">
        <label>Descripción (opcional)</label>
        <input type="text" [(ngModel)]="formGasto.descripcion" placeholder="Ej. Croquetas 3kg" />
      </div>

      <div class="hint">
        Se registrará en <b>{{ nombreMes(mesSeleccionado) }} {{ anioSeleccionado }}</b>.
      </div>
    </div>

    <div class="pc-modal-actions">
      <button class="btn secondary" (click)="cerrarModales()">Cancelar</button>
      <button class="btn primary" [disabled]="loading" (click)="guardarGasto()">Guardar</button>
    </div>
  </div>
</div>

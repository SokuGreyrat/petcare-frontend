<!-- Header / Top bar -->
<div class="pc-card pc-shadow p-3 mb-3 pc-page-head">
  <div>
    <div class="h3 m-0 pc-title">Dashboard</div>
    <div class="pc-muted">Tu feed general y novedades.</div>
  </div>

  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-outline-light pc-btn pc-icon" (click)="reload()" title="Recargar">
      <i class="bi bi-arrow-clockwise"></i>
    </button>

    <button class="btn btn-primary pc-btn" (click)="openCreate()">
      <i class="bi bi-plus-lg me-1"></i>
      Nuevo post
    </button>
  </div>
</div>

<div class="row g-3">
  <!-- FEED -->
  <div class="col-12 col-xl-8">
    <div class="d-grid gap-3">

      @if (busy()) {
        <div class="pc-card pc-shadow p-4 d-flex align-items-center gap-2">
          <span class="spinner-border spinner-border-sm"></span>
          <span>Cargando…</span>
        </div>
      }

      @if (feed().length === 0 && !busy()) {
        <div class="pc-card pc-shadow p-4 pc-empty">
          <div class="pc-empty-icon mb-2"><i class="bi bi-journal-text"></i></div>
          <div class="h5 pc-title mb-1">Todavía no hay publicaciones</div>
          <div class="pc-muted">Crea tu primer post para comenzar.</div>
          <div class="mt-3">
            <button class="btn btn-primary pc-btn" (click)="openCreate()">
              <i class="bi bi-plus-lg me-1"></i>
              Publicar
            </button>
          </div>
        </div>
      }

      @for (p of feed(); track p.id) {
        <div class="pc-card pc-shadow p-3 pc-post">

          <!-- Header del post -->
          <div class="d-flex gap-2 align-items-start">
            <div class="pc-post-avatar">
              @if (userPhoto(p.usuarioId)) {
                <img [src]="userPhoto(p.usuarioId)" alt="" />
              } @else {
                <i class="bi bi-person"></i>
              }
            </div>

            <div class="flex-grow-1">
              <div class="d-flex align-items-start justify-content-between gap-2">
                <div class="min-w-0">
                  <div class="fw-semibold text-truncate">{{ userName(p.usuarioId) }}</div>
                  <div class="small pc-muted">{{ format(p.createdAt) }}</div>
                </div>

                <span class="pc-badge">
                  <i class="bi bi-globe2 me-1"></i> General
                </span>
              </div>

              <div class="pc-divider my-3"></div>

              <!-- Contenido -->
              <div class="pc-post-text" style="white-space: pre-wrap;">{{ p.contenido }}</div>

              <!-- Imagen principal -->
              @if (p.imagen) {
                <div class="mt-3">
                  <img class="pc-post-img" [src]="p.imagen" alt="Imagen" />
                </div>
              }

              <!-- Galería -->
              @if (postImages(p.id).length > 0) {
                <div class="pc-post-grid mt-3">
                  @for (im of postImages(p.id); track im.id) {
                    <img [src]="im.imagePath" alt="" />
                  }
                </div>
              }

              <!-- Acciones -->
              <div class="d-flex flex-wrap gap-2 mt-3 pc-action-row">
                <button class="btn btn-outline-light pc-btn pc-pill" (click)="toggleLike(p)">
                  <i class="bi" [class.bi-heart-fill]="isLikedByMe(p.id)" [class.bi-heart]="!isLikedByMe(p.id)"></i>
                  <span class="ms-1">{{ likesCount(p.id) }}</span>
                </button>

                <button class="btn btn-outline-light pc-btn pc-pill" (click)="toggleComments(p.id)">
                  <i class="bi bi-chat"></i>
                  <span class="ms-1">{{ commentsFor(p.id).length }}</span>
                </button>

                <button class="btn btn-outline-light pc-btn pc-icon" (click)="reload()" title="Recargar">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>

              <!-- Comentarios -->
              @if (expandedComments()[p.id || -1]) {
                <div class="pc-divider my-3"></div>

                <div class="d-grid gap-2">
                  @for (c of commentsFor(p.id); track c.id) {
                    <div class="pc-surface p-3 pc-comment">
                      <div class="d-flex align-items-center justify-content-between gap-2">
                        <div class="small fw-semibold">{{ userName(c.userId) }}</div>
                        <div class="small pc-muted">{{ format(c.fechaCreacion) }}</div>
                      </div>
                      <div class="small mt-1" style="white-space: pre-wrap;">{{ c.contenido }}</div>
                    </div>
                  }
                </div>

                <form class="mt-3" [formGroup]="commentForms()[p.id || -1]" (ngSubmit)="submitComment(p.id!)">
                  <div class="d-flex gap-2">
                    <input class="form-control pc-input" formControlName="contenido" placeholder="Escribe un comentario…" />
                    <button class="btn btn-primary pc-btn pc-icon" type="submit" title="Enviar">
                      <i class="bi bi-send"></i>
                    </button>
                  </div>
                </form>
              }
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="col-12 col-xl-4">
    <div class="pc-card pc-shadow p-3 pc-sidebar">
      <div class="h5 pc-title mb-0">Estado rápido</div>
      <div class="pc-muted small">Datos del feed (global)</div>

      <div class="pc-divider my-3"></div>

      <div class="pc-kpi">
        <div class="pc-kpi-item">
          <div class="label">Posts</div>
          <div class="value">{{ posts().length }}</div>
        </div>

        <div class="pc-kpi-item">
          <div class="label">Likes</div>
          <div class="value">{{ likes().length }}</div>
        </div>

        <div class="pc-kpi-item">
          <div class="label">Comentarios</div>
          <div class="value">{{ comments().length }}</div>
        </div>
      </div>
    </div>

    <!-- ✅ Tips eliminado (borrado a propósito) -->
  </div>
</div>

<app-modal [open]="showCreate()" title="Nuevo post" (closed)="showCreate.set(false)">
  <form [formGroup]="createForm" (ngSubmit)="createPost()" class="d-grid gap-3">
    <div>
      <label class="form-label">Contenido</label>
      <textarea class="form-control pc-input" rows="4" formControlName="contenido"
                placeholder="¿Qué pasó hoy con tu mascota?"></textarea>
      @if (createForm.controls.contenido.touched && createForm.controls.contenido.invalid) {
        <div class="text-warning small mt-1">Escribe al menos 2 caracteres.</div>
      }
    </div>

    <div class="row g-2">
      <div class="col-12">
        <label class="form-label">Imagen principal (URL, opcional)</label>
        <input class="form-control pc-input" formControlName="imagen" placeholder="https://..." />
      </div>
      <div class="col-12">
        <label class="form-label">Galería (URLs, una por línea, opcional)</label>
        <textarea class="form-control pc-input" rows="3" formControlName="extraImages"
                  placeholder="https://...\nhttps://..."></textarea>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <button type="button" class="btn btn-outline-light pc-btn" (click)="showCreate.set(false)">Cancelar</button>
      <button class="btn btn-primary pc-btn" type="submit">Publicar</button>
    </div>
  </form>
</app-modal>
